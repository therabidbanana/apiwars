<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>api_wars.rb</title>
  <link rel="stylesheet" href="http://github.com/jashkenas/docco/raw/0.3.0/resources/docco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>api_wars.rb</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-API_Wars'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-API_Wars">&#182;</a>
        </div>
        <p><a href="https://github.com/therabidbanana/apiwars"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://d3nwyuy0nl342s.cloudfront.net/img/30f550e0d38ceb6ef5b81500c64d970b7fb0f028/687474703a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6f72616e67655f6666373630302e706e67" alt="Fork me on GitHub"></a></p>

<h1>API Wars</h1>

<p><strong>APIWars</strong> is a game for nerds. There is no UI. All
of the actions are accomplished via RESTful actions
to the Grid, Players or Test objects.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-Installation'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Installation">&#182;</a>
        </div>
        <h1>Installation</h1>

<p>The game is a small Sinatra script that can be installed
on any server that can run a Sinatra app and has database
access (using DataMapper for database communications).</p>

<p>API Wars is intended to be hosted on your own server to
play with your nerdier friends/colleagues &ndash; so some
assembly is required (Heroku makes it dead-easy though.)</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-Requirements'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Requirements">&#182;</a>
        </div>
        <h2>Requirements</h2>

<p>A gemfile is included &ndash; just run &ldquo;bundle install&rdquo; to
get the necessary gems</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">require</span> <span class="s1">&#39;rubygems&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;sinatra&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;dm-core&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;dm-serializer&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;dm-timestamps&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;dm-migrations&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;haml&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;digest/md5&#39;</span></pre></div>
      </td>
    </tr>
    <tr id='section-OAuth_Setup'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-OAuth_Setup">&#182;</a>
        </div>
        <h2>OAuth Setup</h2>

<p>We use OmniAuth for authentication to reduce complexity.
Currently the script uses Github&rsquo;s OAuth. You&rsquo;ll need
to request an oauth application on their site:</p>

<p>https://github.com/account/applications/new</p>

<p>Set the callback like so:</p>

<pre><code>http://mygame.example.com/auth/github/callback
</code></pre>

<p>It should be pretty easy to use something else
(FB, Twitter, etc.) Check out the Omniauth Docs.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">require</span> <span class="s1">&#39;oa-oauth&#39;</span></pre></div>
      </td>
    </tr>
    <tr id='section-5'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-5">&#182;</a>
        </div>
        <p>Set your Github Key and Secret here, or with ENV variables
(good for heroku.) Note the ones in this file are registered to
localhost:4567 for testing.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">use</span> <span class="no">OmniAuth</span><span class="o">::</span><span class="no">Strategies</span><span class="o">::</span><span class="no">GitHub</span><span class="p">,</span> 
  <span class="p">(</span><span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;GITHUB_KEY&#39;</span><span class="o">]</span> <span class="o">||</span> <span class="s1">&#39;5ce55eaa17d66bf4f9cf&#39;</span><span class="p">),</span> 
  <span class="p">(</span><span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;GITHUB_SECRET&#39;</span><span class="o">]</span> <span class="o">||</span> <span class="s1">&#39;350137e0a82fd6402fddaa2992ff80b2ed46eff0&#39;</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-Database'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Database">&#182;</a>
        </div>
        <h2>Database</h2>

<p>Set your database url with an ENV variable or in place
of the url below. Make sure you have the appropraite
datamapper gem installed for your database:
mysql => dm-mysql-adapter
posgres => dm-postgres-adapter</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="no">DataMapper</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="ss">:default</span><span class="p">,</span> 
                 <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;DATABASE_URL&#39;</span><span class="o">]</span> <span class="o">||</span> <span class="s1">&#39;sqlite://&#39;</span><span class="o">+</span><span class="no">Dir</span><span class="o">.</span><span class="n">pwd</span><span class="o">+</span><span class="s1">&#39;/testing.sqlite&#39;</span><span class="p">)</span>


<span class="n">configure</span> <span class="k">do</span>
  <span class="n">enable</span> <span class="ss">:sessions</span></pre></div>
      </td>
    </tr>
    <tr id='section-Goal'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Goal">&#182;</a>
        </div>
        <h2>Goal </h2>

<p>The goal of the game is simple &ndash; to own the most grid
spaces. Players accomplish this with PUTs to grid spaces.
max_spaces is the maximum amount of grid spaces available
to players</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">set</span> <span class="ss">:max_spaces</span><span class="p">,</span> <span class="mi">60</span><span class="o">**</span><span class="mi">2</span></pre></div>
      </td>
    </tr>
    <tr id='section-Players'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Players">&#182;</a>
        </div>
        <h2>Players</h2>

<p>You&rsquo;ll probably want at least 2. For github
authentication, use nicknames.
Other authentication types not supported, but
should be trivial to add on with a bit of reading
the OmniAuth docs.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">set</span> <span class="ss">:players</span><span class="p">,</span> <span class="o">[</span> <span class="o">[</span><span class="s1">&#39;github&#39;</span><span class="p">,</span> <span class="s1">&#39;therabidbanana&#39;</span><span class="o">]</span><span class="p">,</span> 
                  <span class="o">[</span><span class="s1">&#39;github&#39;</span><span class="p">,</span> <span class="s1">&#39;shaineh&#39;</span><span class="o">]</span><span class="p">,</span>
                  <span class="o">[</span><span class="s1">&#39;github&#39;</span><span class="p">,</span> <span class="s1">&#39;eperiodfperiod&#39;</span><span class="o">]</span><span class="p">,</span>
                  <span class="o">[</span><span class="s1">&#39;github&#39;</span><span class="p">,</span> <span class="s1">&#39;radicaleggnog&#39;</span><span class="o">]]</span></pre></div>
      </td>
    </tr>
    <tr id='section-Moves'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Moves">&#182;</a>
        </div>
        <h2>Moves</h2>

<p>Play is accomplished with RESTful calls. Players are
limited to the amount of calls they can make
in a single day.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">set</span> <span class="ss">:max_calls</span><span class="p">,</span> <span class="mi">250</span></pre></div>
      </td>
    </tr>
    <tr id='section-10'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-10">&#182;</a>
        </div>
        <p>DELETEs, PUTs and POSTs are more costly than GETs because
they can do more.
HEADs are cheap, but don&rsquo;t give much.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">set</span> <span class="ss">:method_values</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;GET&quot;</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;7&quot;</span><span class="p">,</span> 
    <span class="s2">&quot;PUT&quot;</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;DELETE&quot;</span> <span class="o">=&gt;</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;HEAD&quot;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">}</span>
<span class="k">end</span>


<span class="no">DataMapper</span><span class="o">::</span><span class="no">Property</span><span class="o">::</span><span class="nb">String</span><span class="o">.</span><span class="n">length</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-The_Grid'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-The_Grid">&#182;</a>
        </div>
        <h2>The Grid</h2>

<p>To make things a bit more challenging, only certain
grid spaces are actually valid. Any grid id passed will
be hashed and turned into a 16 bit integer.</p>

<p>This means players should use GETs to find possible grid
spaces before spending more costly PUTs.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="k">class</span> <span class="nc">GridSpace</span>
  <span class="kp">include</span> <span class="no">DataMapper</span><span class="o">::</span><span class="no">Resource</span>
  <span class="n">property</span> <span class="ss">:id</span><span class="p">,</span> <span class="nb">Integer</span><span class="p">,</span> <span class="ss">:key</span><span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="n">property</span> <span class="ss">:attack</span><span class="p">,</span> <span class="nb">Integer</span><span class="p">,</span> <span class="ss">:default</span> <span class="o">=&gt;</span> <span class="mi">0</span>
  <span class="n">property</span> <span class="ss">:defense</span><span class="p">,</span> <span class="nb">Integer</span><span class="p">,</span> <span class="ss">:default</span> <span class="o">=&gt;</span> <span class="mi">0</span>
  <span class="n">property</span> <span class="ss">:hits</span><span class="p">,</span> <span class="nb">Integer</span><span class="p">,</span> <span class="ss">:default</span> <span class="o">=&gt;</span> <span class="mi">0</span>
  <span class="n">belongs_to</span> <span class="ss">:player</span><span class="p">,</span> <span class="ss">:required</span> <span class="o">=&gt;</span> <span class="kp">false</span>
  <span class="k">def</span> <span class="nf">color</span>
    <span class="k">return</span> <span class="s2">&quot;#fff&quot;</span> <span class="k">unless</span> <span class="n">player</span>
    <span class="k">return</span> <span class="s2">&quot;#</span><span class="si">#{</span><span class="no">Digest</span><span class="o">::</span><span class="no">MD5</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">(</span><span class="n">player</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">to_s</span><span class="p">)</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">5</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">reset!</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">player</span> <span class="o">=</span> <span class="kp">nil</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">attack</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">defense</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">hits</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">save</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-Occupation'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Occupation">&#182;</a>
        </div>
        <h2>Occupation</h2>

<p>PUTs of units are only successful if Grid space is
unoccupied or already owned by the player.</p>

<p>DELETEs are more costly, but will attack other players
if they are occupying the space (and occupy an unoccupied
space).</p>

<p>Units have three attributes: attack, defense and hp.
These are used to calculate if a DELETE is successful.
Several DELETEs may be necessary to remove an occupying
unit.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">claim?</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
    <span class="k">return</span> <span class="kp">false</span> <span class="k">unless</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">player</span><span class="o">.</span><span class="n">nil?</span> <span class="o">||</span> <span class="nb">self</span><span class="o">.</span><span class="n">player</span> <span class="o">==</span> <span class="n">p1</span><span class="p">)</span>
    <span class="k">return</span> <span class="kp">false</span> <span class="k">unless</span> <span class="n">unit</span>
    <span class="no">Unit</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="ss">:player</span> <span class="o">=&gt;</span> <span class="n">p1</span><span class="p">)</span><span class="o">.</span><span class="n">occupy</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">save</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">attack?</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
    <span class="k">return</span> <span class="kp">true</span> <span class="k">if</span><span class="p">(</span><span class="n">claim?</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">unit</span><span class="p">))</span>
    <span class="k">return</span> <span class="kp">false</span> <span class="k">unless</span> <span class="n">unit</span>
    <span class="n">attacker</span> <span class="o">=</span> <span class="no">Unit</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="ss">:player</span> <span class="o">=&gt;</span> <span class="n">p1</span><span class="p">)</span>
    <span class="n">defender</span> <span class="o">=</span> <span class="no">Unit</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
    <span class="n">defender</span><span class="o">.</span><span class="n">attacked_by!</span><span class="p">(</span><span class="n">attacker</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">defender</span><span class="o">.</span><span class="n">alive?</span> 
      <span class="n">defender</span><span class="o">.</span><span class="n">occupy</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">save</span>
      <span class="k">return</span> <span class="kp">false</span>
    <span class="k">else</span>
      <span class="n">attacker</span><span class="o">.</span><span class="n">revive</span>
      <span class="n">attacker</span><span class="o">.</span><span class="n">occupy</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">save</span>
      <span class="k">return</span> <span class="kp">true</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-13'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-13">&#182;</a>
        </div>
        <p>A representation of a unit for occupying grid spaces</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="k">class</span> <span class="nc">Unit</span>
  <span class="kp">attr_reader</span> <span class="ss">:attack</span><span class="p">,</span> <span class="ss">:defense</span><span class="p">,</span> <span class="ss">:hits</span><span class="p">,</span> <span class="ss">:player</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">opts</span> <span class="o">=</span><span class="p">{})</span>
    <span class="k">case</span> <span class="n">unit</span>
    <span class="k">when</span> <span class="nb">String</span>
      <span class="n">digest</span> <span class="o">=</span> <span class="no">Digest</span><span class="o">::</span><span class="no">MD5</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">(</span><span class="no">Player</span><span class="o">.</span><span class="n">secret_sauce</span> <span class="o">+</span> <span class="n">unit</span><span class="p">)</span>
      <span class="vi">@attack</span> <span class="o">=</span> <span class="nb">Integer</span><span class="p">(</span><span class="s2">&quot;0x</span><span class="si">#{</span><span class="n">digest</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">1</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
      <span class="vi">@defense</span> <span class="o">=</span> <span class="nb">Integer</span><span class="p">(</span><span class="s2">&quot;0x</span><span class="si">#{</span><span class="n">digest</span><span class="o">[</span><span class="mi">3</span><span class="o">.</span><span class="n">.</span><span class="mi">4</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
      <span class="vi">@hits</span> <span class="o">=</span> <span class="nb">Integer</span><span class="p">(</span><span class="s2">&quot;0x</span><span class="si">#{</span><span class="n">digest</span><span class="o">[</span><span class="mi">6</span><span class="o">.</span><span class="n">.</span><span class="mi">7</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">when</span> <span class="no">GridSpace</span>
      <span class="vi">@attack</span> <span class="o">=</span> <span class="n">unit</span><span class="o">.</span><span class="n">attack</span>
      <span class="vi">@defense</span> <span class="o">=</span> <span class="n">unit</span><span class="o">.</span><span class="n">defense</span>
      <span class="vi">@hits</span> <span class="o">=</span> <span class="n">unit</span><span class="o">.</span><span class="n">hits</span>
      <span class="vi">@player</span> <span class="o">=</span> <span class="n">unit</span><span class="o">.</span><span class="n">player</span>
    <span class="k">when</span> <span class="nb">Array</span>
      <span class="vi">@attack</span><span class="p">,</span> <span class="vi">@defense</span><span class="p">,</span> <span class="vi">@hits</span> <span class="o">=</span> <span class="o">*</span><span class="n">unit</span>
    <span class="k">else</span>
      <span class="vi">@attack</span> <span class="o">=</span> <span class="vi">@defense</span> <span class="o">=</span> <span class="vi">@hits</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">end</span>
    <span class="vi">@player</span> <span class="o">=</span> <span class="n">opts</span><span class="o">[</span><span class="ss">:player</span><span class="o">]</span> <span class="k">if</span> <span class="n">opts</span><span class="o">[</span><span class="ss">:player</span><span class="o">]</span>
  <span class="k">end</span>
  
  <span class="k">def</span> <span class="nf">occupy</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
    <span class="n">g</span><span class="o">.</span><span class="n">player</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">attack</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">defense</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">hits</span> <span class="o">=</span> <span class="n">player</span><span class="p">,</span> <span class="n">attack</span><span class="p">,</span> <span class="n">defense</span><span class="p">,</span> <span class="n">hits</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">alive?</span>
    <span class="vi">@hits</span> <span class="o">&gt;</span> <span class="mi">0</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">revive</span>
    <span class="vi">@hits</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">unless</span> <span class="n">alive?</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">hit_with</span><span class="p">(</span><span class="n">atk</span><span class="p">)</span>
    <span class="n">atk</span> <span class="o">=</span> <span class="n">atk</span> <span class="o">-</span> <span class="nb">self</span><span class="o">.</span><span class="n">defense</span>
    <span class="n">atk</span> <span class="o">=</span> <span class="p">(</span><span class="n">atk</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)?</span> <span class="n">atk</span> <span class="p">:</span> <span class="mi">1</span>
    <span class="vi">@hits</span> <span class="o">=</span> <span class="vi">@hits</span> <span class="o">-</span><span class="n">atk</span>
    <span class="vi">@hits</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">unless</span> <span class="n">alive?</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">attacked_by!</span><span class="p">(</span><span class="n">unit2</span><span class="p">)</span>
    <span class="n">hit_with</span><span class="p">(</span><span class="n">unit2</span><span class="o">.</span><span class="n">attack</span><span class="p">)</span>
    <span class="n">unit2</span><span class="o">.</span><span class="n">hit_with</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">attack</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">to_json</span>
    <span class="p">{</span><span class="ss">:attack</span> <span class="o">=&gt;</span> <span class="n">attack</span><span class="p">,</span> <span class="ss">:defense</span> <span class="o">=&gt;</span> <span class="n">defense</span><span class="p">,</span> <span class="ss">:hits</span> <span class="o">=&gt;</span> <span class="n">hits</span><span class="p">}</span><span class="o">.</span><span class="n">to_json</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Player</span>
  <span class="kp">include</span> <span class="no">DataMapper</span><span class="o">::</span><span class="no">Resource</span>
  <span class="n">property</span> <span class="ss">:id</span><span class="p">,</span> <span class="no">Serial</span>
  <span class="n">property</span> <span class="ss">:provider</span><span class="p">,</span> <span class="nb">String</span>
  <span class="n">property</span> <span class="ss">:uid</span><span class="p">,</span> <span class="nb">String</span>
  <span class="n">property</span> <span class="ss">:api</span><span class="p">,</span> <span class="nb">String</span>
  <span class="n">property</span> <span class="ss">:sauce</span><span class="p">,</span> <span class="nb">String</span>
  <span class="n">property</span> <span class="ss">:pin</span><span class="p">,</span> <span class="nb">String</span><span class="p">,</span> <span class="ss">:length</span> <span class="o">=&gt;</span> <span class="mi">4</span>
  <span class="n">property</span> <span class="ss">:created_on</span><span class="p">,</span> <span class="no">DateTime</span>
  <span class="n">property</span> <span class="ss">:reset_on</span><span class="p">,</span> <span class="no">DateTime</span><span class="p">,</span> <span class="ss">:default</span> <span class="o">=&gt;</span> <span class="no">DateTime</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;1/1/11&quot;</span><span class="p">)</span>
  <span class="n">property</span> <span class="ss">:daily_calls</span><span class="p">,</span> <span class="nb">Integer</span><span class="p">,</span> <span class="ss">:default</span> <span class="o">=&gt;</span> <span class="mi">0</span>
  <span class="n">has</span> <span class="n">n</span><span class="p">,</span> <span class="ss">:grid_spaces</span>
  </pre></div>
      </td>
    </tr>
    <tr id='section-The_secret_sauce'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-The_secret_sauce">&#182;</a>
        </div>
        <h3>The secret sauce</h3>

<p>The secret sauce is a salt for all of the
hash functions done in the game.</p>

<p>We concatenate all players' sauce to create
a string that&rsquo;s not guessable to any
particular player (unless they have DB access).</p>

<p>Resetting your own sauce will completely modify the
game board, possibly invalidating everything you know.
Probably a good way to stay ahead, or just mess people.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">secret_sauce</span>
    <span class="n">sauce</span> <span class="o">=</span> <span class="s2">&quot;extra delicious&quot;</span>
    <span class="no">Player</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">each</span><span class="p">{</span> <span class="o">|</span><span class="nb">p</span><span class="o">|</span> <span class="n">sauce</span> <span class="o">+=</span> <span class="nb">p</span><span class="o">.</span><span class="n">sauce</span> <span class="k">if</span> <span class="nb">p</span><span class="o">.</span><span class="n">sauce</span> <span class="p">}</span>
    <span class="n">sauce</span>
  <span class="k">end</span>

  
  <span class="k">def</span> <span class="nf">api</span>
    <span class="n">generate_key!</span> <span class="k">unless</span> <span class="nb">self</span><span class="o">.</span><span class="n">attribute_get</span><span class="p">(</span><span class="ss">:api</span><span class="p">)</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">attribute_get</span><span class="p">(</span><span class="ss">:api</span><span class="p">)</span>
  <span class="k">end</span>
  
  <span class="k">def</span> <span class="nf">generate_key!</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">api</span> <span class="o">=</span> <span class="no">Digest</span><span class="o">::</span><span class="no">MD5</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">(</span><span class="s2">&quot;player: &quot;</span><span class="o">+</span><span class="nb">id</span><span class="o">.</span><span class="n">to_s</span><span class="o">+</span>
                                     <span class="n">provider</span><span class="o">+</span><span class="n">uid</span><span class="o">+</span><span class="no">Player</span><span class="o">.</span><span class="n">secret_sauce</span><span class="o">+</span>
                                     <span class="n">created_on</span><span class="o">.</span><span class="n">to_s</span><span class="p">)</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">save</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">calls?</span><span class="p">(</span><span class="n">max</span><span class="p">,</span> <span class="n">num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">reset_if_possible</span>
    <span class="n">daily</span><span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">daily_calls</span> <span class="o">||</span> <span class="mi">0</span>
    <span class="n">can</span> <span class="o">=</span> <span class="p">(</span><span class="n">daily</span> <span class="o">+</span> <span class="n">num</span><span class="o">.</span><span class="n">to_i</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">can</span> <span class="o">&lt;=</span> <span class="n">max</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">daily_calls</span> <span class="o">=</span> <span class="n">can</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">save</span>
      <span class="kp">true</span>
    <span class="k">else</span>
      <span class="kp">false</span>
    <span class="k">end</span>
  <span class="k">end</span>
 </pre></div>
      </td>
    </tr>
    <tr id='section-15'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-15">&#182;</a>
        </div>
        <p>The player may reset their pin at any time, but to do so they
loose one of their squares. Pins must be 4 numeric digits,
all other characters are replaced by 0.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">pin</span><span class="o">=</span><span class="p">(</span><span class="n">new_pin</span><span class="p">)</span>
    <span class="n">new_pin</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">unless</span> <span class="n">new_pin</span>
    <span class="n">new_pin</span> <span class="o">=</span> <span class="n">new_pin</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">3</span><span class="o">]</span> <span class="c1"># Trim</span>
    <span class="n">new_pin</span> <span class="o">=</span> <span class="n">new_pin</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/[^0-9]/</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span>
    <span class="n">new_pin</span> <span class="o">=</span> <span class="n">new_pin</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span>
    <span class="n">disown!</span> <span class="k">unless</span> <span class="nb">self</span><span class="o">.</span><span class="n">pin</span> <span class="o">==</span> <span class="n">new_pin</span>
    <span class="k">super</span><span class="p">(</span><span class="n">new_pin</span><span class="p">)</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-16'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-16">&#182;</a>
        </div>
        <p>If a player resets their pin, this method is called</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">disown!</span>
    <span class="k">if</span> <span class="n">space</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">grid_spaces</span><span class="o">.</span><span class="n">first</span>
      <span class="n">space</span><span class="o">.</span><span class="n">reset!</span>
    <span class="k">end</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">grid_spaces</span><span class="o">.</span><span class="n">reload</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-17'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-17">&#182;</a>
        </div>
        <p>The player may reset their own sauce at any time. This
changes the hashes that run the game for everyone, so
to limit the destructive tendencies of players, they
must be willing to give up their spaces.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">sauce</span><span class="o">=</span><span class="p">(</span><span class="n">new_sauce</span><span class="p">)</span>
    <span class="n">disown_all!</span> <span class="k">unless</span> <span class="nb">self</span><span class="o">.</span><span class="n">sauce</span> <span class="o">==</span> <span class="n">new_sauce</span>
    <span class="k">super</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-18'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-18">&#182;</a>
        </div>
        <p>If a player resets their sauce, this method is called</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">disown_all!</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">grid_spaces</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span>
      <span class="n">s</span><span class="o">.</span><span class="n">reset!</span>
    <span class="k">end</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">grid_spaces</span><span class="o">.</span><span class="n">reload</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-19'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-19">&#182;</a>
        </div>
        <p>Every 24 hours the player gets their call count reset. This happens
on their next call.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">reset_if_possible</span>
    <span class="n">now</span> <span class="o">=</span> <span class="no">DateTime</span><span class="o">.</span><span class="n">now</span>
    <span class="n">reset_time</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">reset_on</span> <span class="o">||</span> <span class="no">DateTime</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;1/1/11&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">reset_on</span><span class="p">)</span><span class="o">.</span><span class="n">to_f</span> <span class="o">&gt;</span> <span class="mi">1</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">reset_on</span> <span class="o">=</span> <span class="n">now</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">daily_calls</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">save</span>
    <span class="k">else</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">reset_on</span> <span class="o">=</span> <span class="n">reset_time</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">save</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-20'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-20">&#182;</a>
        </div>
        <p>For storing game data. May be used for historical tracking
in some future version.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="k">class</span> <span class="nc">Game</span>
  <span class="kp">include</span> <span class="no">DataMapper</span><span class="o">::</span><span class="no">Resource</span>
  <span class="n">property</span> <span class="ss">:id</span><span class="p">,</span> <span class="no">Serial</span>
  <span class="n">property</span> <span class="ss">:created_on</span><span class="p">,</span> <span class="no">DateTime</span>
  <span class="n">property</span> <span class="ss">:name</span><span class="p">,</span> <span class="nb">String</span>
<span class="k">end</span>

<span class="no">DataMapper</span><span class="o">.</span><span class="n">finalize</span>


<span class="n">helpers</span> <span class="k">do</span></pre></div>
      </td>
    </tr>
    <tr id='section-21'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-21">&#182;</a>
        </div>
        <p>All moves require valid authentication
parameters to be passed are:
   key:  the user&rsquo;s API key
   pin:  a valid user pin</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">api_authorized?</span>
    <span class="n">halt</span><span class="p">(</span><span class="mi">401</span><span class="p">,</span> <span class="s1">&#39;Valid API Key Required&#39;</span><span class="p">)</span> <span class="k">unless</span> <span class="n">params</span><span class="o">[</span><span class="s2">&quot;key&quot;</span><span class="o">]</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">p</span> <span class="o">=</span> <span class="no">Player</span><span class="o">.</span><span class="n">first</span><span class="p">(</span><span class="ss">:api</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="s2">&quot;key&quot;</span><span class="o">]</span><span class="p">))</span>
      <span class="n">request</span><span class="o">.</span><span class="n">env</span><span class="o">[</span><span class="s1">&#39;api_player&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="nb">p</span>
      <span class="n">pin_player</span> <span class="o">=</span> <span class="no">Player</span><span class="o">.</span><span class="n">first</span><span class="p">(</span><span class="ss">:pin</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="s2">&quot;pin&quot;</span><span class="o">]</span><span class="p">)</span>
      <span class="n">pin_player</span> <span class="o">=</span> <span class="nb">p</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">path_info</span> <span class="o">==</span> <span class="s2">&quot;/player/&quot;</span><span class="o">+</span><span class="nb">p</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">to_s</span>
      <span class="k">if</span> <span class="n">pin_player</span></pre></div>
      </td>
    </tr>
    <tr id='section-22'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-22">&#182;</a>
        </div>
        <p>Note that the pin doesn&rsquo;t have to be the same user
as the api key.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="n">request</span><span class="o">.</span><span class="n">env</span><span class="o">[</span><span class="s1">&#39;pin_player&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="n">pin_player</span>
      <span class="k">else</span></pre></div>
      </td>
    </tr>
    <tr id='section-23'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-23">&#182;</a>
        </div>
        <p>But we count invalid pins against the API
key player, so it&rsquo;s risky to waste
API calls trying to find out someone
else&rsquo;s PIN.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="nb">p</span><span class="o">.</span><span class="n">calls?</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">max_calls</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">halt</span> <span class="mi">401</span><span class="p">,</span> <span class="s1">&#39;Valid Pin Required&#39;</span>
      <span class="k">end</span>
    <span class="k">else</span>
      <span class="n">halt</span> <span class="mi">401</span><span class="p">,</span> <span class="s1">&#39;Valid API Key Required&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">has_calls?</span></pre></div>
      </td>
    </tr>
    <tr id='section-24'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-24">&#182;</a>
        </div>
        <p>Checks to make sure player has moves left
before allowing move.</p>

<p>Remember the pin player can be any player,
not necessarily the same one as the API key.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nb">p</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">env</span><span class="o">[</span><span class="s1">&#39;pin_player&#39;</span><span class="o">]</span>
    <span class="n">spent</span> <span class="o">=</span> <span class="nb">p</span><span class="o">.</span><span class="n">calls?</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">max_calls</span><span class="p">,</span> 
                     <span class="n">settings</span><span class="o">.</span><span class="n">method_values</span><span class="o">[</span><span class="n">request</span><span class="o">.</span><span class="n">request_method</span><span class="o">]</span><span class="p">)</span>
    <span class="n">halt</span><span class="p">(</span><span class="mi">402</span><span class="p">,</span> <span class="s1">&#39;Not enough calls&#39;</span><span class="p">)</span> <span class="k">unless</span> <span class="n">spent</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-25'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-25">&#182;</a>
        </div>
        <p>Redirect to seed game if DataMapper can&rsquo;t find an
existing game (so all we need to do to install is
visit the home page once)</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">game?</span>
    <span class="k">begin</span>
      <span class="no">Game</span><span class="o">.</span><span class="n">first</span>
    <span class="k">rescue</span> <span class="no">Exception</span> <span class="o">=&gt;</span> <span class="n">e</span>
      <span class="n">redirect</span> <span class="s1">&#39;/game/seed&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">before</span> <span class="sr">%r{!(/game/seed/?)}</span> <span class="k">do</span>
  <span class="n">game?</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-26'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-26">&#182;</a>
        </div>
        <p>Grid and Player resources require authorization</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">before</span> <span class="sr">%r{/(grid|player|test)/.+}</span> <span class="k">do</span>
  <span class="n">api_authorized?</span>
  <span class="n">has_calls?</span>
  <span class="n">cache_control</span> <span class="ss">:no_cache</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-27'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-27">&#182;</a>
        </div>
        <p>Get info about a given grid space.
Note that the :space id is hashed with the
secret sauce and converted to an integer, then
we test to see if it is a valid grid space.</p>

<p>Differs from a GET in that you do not receive info
about whether another player is already occupying
a square.</p>

<p>HEAD /grid/:space</p>

<p>  (Requires key and pin arguments)</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">head</span> <span class="s2">&quot;/grid/:space&quot;</span> <span class="k">do</span>
  <span class="n">space</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:space</span><span class="o">]</span> <span class="o">+</span> <span class="no">Player</span><span class="o">.</span><span class="n">secret_sauce</span>
  <span class="n">digest</span> <span class="o">=</span> <span class="no">Digest</span><span class="o">::</span><span class="no">MD5</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">(</span><span class="n">space</span><span class="p">)</span>
  <span class="nb">id</span> <span class="o">=</span> <span class="nb">Integer</span><span class="p">(</span><span class="s2">&quot;0x</span><span class="si">#{</span><span class="n">digest</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">3</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
  <span class="k">if</span><span class="p">(</span><span class="n">g</span> <span class="o">=</span><span class="no">GridSpace</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span></pre></div>
      </td>
    </tr>
    <tr id='section-28'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-28">&#182;</a>
        </div>
        <p>Returns 200 with empty body</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">halt</span> <span class="mi">200</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
  <span class="k">else</span></pre></div>
      </td>
    </tr>
    <tr id='section-29'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-29">&#182;</a>
        </div>
        <p>Oherwise, returns 404</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">halt</span> <span class="mi">404</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-30'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-30">&#182;</a>
        </div>
        <p>Get info about a given grid space.
Note that the :space id is hashed with the
secret sauce and converted to an integer, then
we test to see if it is a valid grid space.</p>

<p>GET /grid/:space</p>

<p>  (Requires key and pin arguments)</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">get</span> <span class="s2">&quot;/grid/:space&quot;</span> <span class="k">do</span>
  <span class="n">space</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:space</span><span class="o">]</span> <span class="o">+</span> <span class="no">Player</span><span class="o">.</span><span class="n">secret_sauce</span>
  <span class="n">digest</span> <span class="o">=</span> <span class="no">Digest</span><span class="o">::</span><span class="no">MD5</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">(</span><span class="n">space</span><span class="p">)</span>
  <span class="nb">id</span> <span class="o">=</span> <span class="nb">Integer</span><span class="p">(</span><span class="s2">&quot;0x</span><span class="si">#{</span><span class="n">digest</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">3</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
  <span class="k">if</span><span class="p">(</span><span class="n">g</span> <span class="o">=</span><span class="no">GridSpace</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span></pre></div>
      </td>
    </tr>
    <tr id='section-31'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-31">&#182;</a>
        </div>
        <p>Returns 200 with hash of space info on success</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">status</span> <span class="mi">200</span>
    <span class="n">g</span><span class="o">.</span><span class="n">to_json</span>
  <span class="k">else</span></pre></div>
      </td>
    </tr>
    <tr id='section-32'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-32">&#182;</a>
        </div>
        <p>Oherwise, returns 404</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">halt</span> <span class="mi">404</span><span class="p">,</span> <span class="s2">&quot;Invalid Space&quot;</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-33'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-33">&#182;</a>
        </div>
        <p>Place a unit on a space, if unoccupied and valid.</p>

<p>PUT /grid/:space?unit=foo
  unit: a string to be hashed to create unit attributes</p>

<p>  (Requires key and pin arguments)</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">put</span> <span class="s2">&quot;/grid/:space&quot;</span> <span class="k">do</span>
  <span class="n">space</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:space</span><span class="o">]</span> <span class="o">+</span> <span class="no">Player</span><span class="o">.</span><span class="n">secret_sauce</span>
  <span class="n">digest</span> <span class="o">=</span> <span class="no">Digest</span><span class="o">::</span><span class="no">MD5</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">(</span><span class="n">space</span><span class="p">)</span>
  <span class="nb">id</span> <span class="o">=</span> <span class="nb">Integer</span><span class="p">(</span><span class="s2">&quot;0x</span><span class="si">#{</span><span class="n">digest</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">3</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
  <span class="k">if</span><span class="p">(</span><span class="n">g</span> <span class="o">=</span><span class="no">GridSpace</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span>
    <span class="n">halt</span> <span class="mi">400</span><span class="p">,</span> <span class="s1">&#39;Requires unit&#39;</span> <span class="k">unless</span> <span class="n">params</span><span class="o">[</span><span class="s2">&quot;unit&quot;</span><span class="o">]</span>
    <span class="k">if</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">claim?</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">env</span><span class="o">[</span><span class="s1">&#39;api_player&#39;</span><span class="o">]</span><span class="p">,</span> <span class="n">params</span><span class="o">[</span><span class="s2">&quot;unit&quot;</span><span class="o">]</span><span class="p">))</span></pre></div>
      </td>
    </tr>
    <tr id='section-34'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-34">&#182;</a>
        </div>
        <p>Returns 201 and a hash of space info on success</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">status</span> <span class="mi">201</span>
      <span class="n">g</span><span class="o">.</span><span class="n">to_json</span>
    <span class="k">else</span></pre></div>
      </td>
    </tr>
    <tr id='section-35'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-35">&#182;</a>
        </div>
        <p>Returns 403 with error if someone else occupies</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">halt</span> <span class="mi">405</span><span class="p">,</span> <span class="s1">&#39;Someone else owns the space&#39;</span>
    <span class="k">end</span>
  <span class="k">else</span></pre></div>
      </td>
    </tr>
    <tr id='section-36'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-36">&#182;</a>
        </div>
        <p>Returns 404 if space id invalid</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">halt</span> <span class="mi">404</span><span class="p">,</span> <span class="s2">&quot;Invalid Space&quot;</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-37'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-37">&#182;</a>
        </div>
        <p>Place a unit on a space, attacking any existing unit on
the space (note attack may not be successful, depending
on occupying unit&rsquo;s attributes)</p>

<p>DELETE /grid/:space?unit=foo
  unit: a string to be hashed to create unit attributes</p>

<p>  (Requires key and pin arguments)</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">delete</span> <span class="s2">&quot;/grid/:space&quot;</span> <span class="k">do</span>
  <span class="n">space</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:space</span><span class="o">]</span> <span class="o">+</span> <span class="no">Player</span><span class="o">.</span><span class="n">secret_sauce</span>
  <span class="n">digest</span> <span class="o">=</span> <span class="no">Digest</span><span class="o">::</span><span class="no">MD5</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">(</span><span class="n">space</span><span class="p">)</span>
  <span class="nb">id</span> <span class="o">=</span> <span class="nb">Integer</span><span class="p">(</span><span class="s2">&quot;0x</span><span class="si">#{</span><span class="n">digest</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">3</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
  <span class="k">if</span><span class="p">(</span><span class="n">g</span> <span class="o">=</span><span class="no">GridSpace</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span>
    <span class="n">halt</span> <span class="mi">400</span><span class="p">,</span> <span class="s1">&#39;Requires unit&#39;</span> <span class="k">unless</span> <span class="n">params</span><span class="o">[</span><span class="s2">&quot;unit&quot;</span><span class="o">]</span>
    <span class="k">if</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">attack?</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">env</span><span class="o">[</span><span class="s1">&#39;api_player&#39;</span><span class="o">]</span> <span class="p">,</span> <span class="n">params</span><span class="o">[</span><span class="s2">&quot;unit&quot;</span><span class="o">]</span><span class="p">))</span>
      <span class="n">status</span> <span class="mi">200</span>
      <span class="n">g</span><span class="o">.</span><span class="n">to_json</span>
    <span class="k">else</span>
      <span class="n">halt</span> <span class="mi">409</span><span class="p">,</span> <span class="s1">&#39;Attack unsuccessful&#39;</span>
    <span class="k">end</span>
  <span class="k">else</span>
    <span class="n">halt</span> <span class="mi">404</span><span class="p">,</span> <span class="s2">&quot;Invalid Space&quot;</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-38'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-38">&#182;</a>
        </div>
        <p>Get info about a given unit without having to put/post.
Note that the :unit id is hashed with the
secret sauce to get attributes.</p>

<p>GET /test/:unit</p>

<p>  (Requires key and pin arguments)</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">get</span> <span class="s2">&quot;/test/:unit&quot;</span> <span class="k">do</span></pre></div>
      </td>
    </tr>
    <tr id='section-39'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-39">&#182;</a>
        </div>
        <p>Returns 200 with hash of space info on success</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">status</span> <span class="mi">200</span>
  <span class="no">Unit</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:unit</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">to_json</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-40'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-40">&#182;</a>
        </div>
        <p>Trying to post to test yields a 418.</p>

<p>POST /test/:unit</p>

<p>  (Requires key and pin arguments)</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">post</span> <span class="s2">&quot;/test/:unit&quot;</span> <span class="k">do</span></pre></div>
      </td>
    </tr>
    <tr id='section-41'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-41">&#182;</a>
        </div>
        <p>Oherwise, returns 404</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">halt</span> <span class="mi">418</span><span class="p">,</span> <span class="s2">&quot;I&#39;m a </span><span class="si">#{</span><span class="nb">rand</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">.</span><span class="mi">5</span> <span class="o">?</span> <span class="s1">&#39;short and stout &#39;</span> <span class="p">:</span> <span class="s1">&#39;&#39;</span> <span class="si">}</span><span class="s2">teapot&quot;</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-42'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-42">&#182;</a>
        </div>
        <p>Run initialization of database if
it hasn&rsquo;t been done yet. Last step before
you can play. Executed automatically first
time site is visited.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">get</span> <span class="s2">&quot;/game/seed&quot;</span> <span class="k">do</span>
  <span class="k">begin</span>
    <span class="no">Game</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="s1">&#39;game already seeded&#39;</span>
  <span class="k">rescue</span> <span class="no">Exception</span> <span class="o">=&gt;</span> <span class="n">e</span>
    <span class="no">DataMapper</span><span class="o">.</span><span class="n">auto_migrate!</span>
    <span class="n">max</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">max_spaces</span>
    <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="n">.max</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">space</span><span class="o">|</span>
      <span class="k">unless</span> <span class="no">GridSpace</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">space</span><span class="p">)</span>
        <span class="no">GridSpace</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">space</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="n">settings</span><span class="o">.</span><span class="n">players</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">provider</span><span class="p">,</span> <span class="n">uid</span><span class="o">|</span>
      <span class="k">unless</span> <span class="no">Player</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="ss">:provider</span> <span class="o">=&gt;</span> <span class="n">provider</span><span class="p">,</span> <span class="ss">:uid</span> <span class="o">=&gt;</span> <span class="n">uid</span><span class="p">)</span>
        <span class="nb">p</span> <span class="o">=</span> <span class="no">Player</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:provider</span> <span class="o">=&gt;</span> <span class="n">provider</span><span class="p">,</span> <span class="ss">:uid</span> <span class="o">=&gt;</span> <span class="n">uid</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="no">Game</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">&#39;Game&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;game ready with &#39;</span><span class="o">+</span><span class="n">settings</span><span class="o">.</span><span class="n">max_spaces</span><span class="o">.</span><span class="n">to_s</span> <span class="o">+</span> <span class="s1">&#39; squares&#39;</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-43'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-43">&#182;</a>
        </div>
        <p>Show a basic message with game status.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">get</span> <span class="s2">&quot;/&quot;</span> <span class="k">do</span>
  <span class="n">expires</span> <span class="mi">1800</span><span class="p">,</span> <span class="ss">:public</span><span class="p">,</span> <span class="ss">:must_revalidate</span>
  <span class="n">haml</span> <span class="ss">:index</span><span class="p">,</span> <span class="ss">:locals</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:spaces</span> <span class="o">=&gt;</span> <span class="no">GridSpace</span><span class="o">.</span><span class="n">all</span><span class="p">,</span> <span class="ss">:players</span> <span class="o">=&gt;</span> <span class="no">Player</span><span class="o">.</span><span class="n">all</span><span class="p">}</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-44'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-44">&#182;</a>
        </div>
        <p>This is how we allow players to access their
API keys &ndash; they log in via Github.</p>

<p>GET /auth/github
   => redirects to Github auth page.
   => if authorized, redirects here.</p>

<p>A form is shown to allow updating pin and sauce</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">get</span> <span class="s2">&quot;/auth/:provider/callback&quot;</span> <span class="k">do</span>
  <span class="n">auth</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">env</span><span class="o">[</span><span class="s1">&#39;omniauth.auth&#39;</span><span class="o">]</span>
  <span class="n">uid</span> <span class="o">=</span> <span class="k">case</span> <span class="n">auth</span><span class="o">[</span><span class="s1">&#39;provider&#39;</span><span class="o">]</span>
  <span class="k">when</span> <span class="s1">&#39;github&#39;</span>
    <span class="n">auth</span><span class="o">[</span><span class="s1">&#39;user_info&#39;</span><span class="o">][</span><span class="s1">&#39;nickname&#39;</span><span class="o">]</span>
  <span class="k">else</span>
    <span class="n">auth</span><span class="o">[</span><span class="s1">&#39;uid&#39;</span><span class="o">]</span>
  <span class="k">end</span>
  <span class="k">if</span><span class="p">(</span><span class="nb">p</span> <span class="o">=</span> <span class="no">Player</span><span class="o">.</span><span class="n">first</span><span class="p">(</span><span class="ss">:provider</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:provider</span><span class="o">]</span><span class="p">,</span> <span class="ss">:uid</span> <span class="o">=&gt;</span> <span class="n">uid</span><span class="p">))</span>
    
    <span class="n">haml</span> <span class="ss">:form</span><span class="p">,</span> <span class="ss">:locals</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:player</span> <span class="o">=&gt;</span> <span class="nb">p</span><span class="p">}</span>
  <span class="k">else</span>
    <span class="n">status</span> <span class="mi">404</span>
    <span class="k">return</span> <span class="s1">&#39;invalid player&#39;</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-45'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-45">&#182;</a>
        </div>
        <p>You may update your pin and sauce at any time.
Updating your pin will ensure nobody can use it to make
calls.</p>

<p>Updating your sauce will change all hash calculations,
completely changing valid grid id&rsquo;s and unit attributes.</p>

<p>POST /player/:id
(Requires key and pin arguments)</p>

      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">post</span> <span class="s2">&quot;/player/:id&quot;</span> <span class="k">do</span>
  <span class="k">if</span> <span class="n">params</span><span class="o">[</span><span class="s2">&quot;key&quot;</span><span class="o">]</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">p</span><span class="o">=</span><span class="no">Player</span><span class="o">.</span><span class="n">first</span><span class="p">(</span><span class="ss">:api</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="s2">&quot;key&quot;</span><span class="o">]</span><span class="p">))</span>
      <span class="k">unless</span> <span class="nb">p</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">].</span><span class="n">to_i</span>
        <span class="n">status</span> <span class="mi">401</span>
        <span class="k">return</span> <span class="s1">&#39;Not allowed to edit other players&#39;</span>
      <span class="k">end</span>
      <span class="k">if</span> <span class="n">params</span><span class="o">[</span><span class="s2">&quot;pin&quot;</span><span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="n">params</span><span class="o">[</span><span class="s2">&quot;pin&quot;</span><span class="o">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span>
        <span class="nb">p</span><span class="o">.</span><span class="n">pin</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="s2">&quot;pin&quot;</span><span class="o">][</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">3</span><span class="o">]</span>
      <span class="k">end</span>
      <span class="k">if</span> <span class="n">params</span><span class="o">[</span><span class="s2">&quot;sauce&quot;</span><span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="n">params</span><span class="o">[</span><span class="s2">&quot;sauce&quot;</span><span class="o">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span>
        <span class="nb">p</span><span class="o">.</span><span class="n">sauce</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="s2">&quot;sauce&quot;</span><span class="o">]</span>
      <span class="k">end</span>

      <span class="nb">p</span><span class="o">.</span><span class="n">save</span>
      <span class="k">return</span> <span class="s1">&#39;Updated player info&#39;</span>
    <span class="k">else</span>
      <span class="n">status</span> <span class="mi">401</span>
      <span class="k">return</span> <span class="s1">&#39;Not allowed (check api key)&#39;</span>
    <span class="k">end</span>
  <span class="k">else</span>
    <span class="n">status</span> <span class="mi">401</span>
    <span class="k">return</span> <span class="s1">&#39;Not allowed, must provide api key&#39;</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
